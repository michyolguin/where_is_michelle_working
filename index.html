<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Where is Michelle working today?</title>
  <meta name="description" content="Quick daily location + schedule for Michelle." />
  <!-- Ubuntu font -->
  <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;500;700&display=swap" rel="stylesheet">
  <!-- Tailwind (official CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Ubuntu', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    .card { border-radius: 1rem; box-shadow: 0 8px 24px rgba(0,0,0,.08); }
    .status-ping::before { content:""; position:absolute; inset:-6px; border-radius:9999px; border:2px solid rgba(255,255,255,.45);
      animation: ping 1.5s cubic-bezier(0, 0, 0.2, 1) infinite; }
    @keyframes ping { 75%,100% { transform:scale(1.6); opacity:0; } }
    .td-wrap { word-wrap: break-word; }
    .sticker {
      position: absolute; top: .35rem; right: 1.35rem;
      transform: rotate(6deg);
      padding: .25rem .45rem; border-radius: .4rem;
      background: #fb7185; color: #fff; font-weight: 700; font-size: .65rem;
      box-shadow: 0 4px 14px rgba(0,0,0,.15); letter-spacing: .3px;
    }
    .cell { position: relative; }
    .active-block { outline: 2px solid rgba(255,255,255,.9); outline-offset: -2px; border-radius: .5rem; background: rgba(255,255,255,.1); }
  </style>
</head>
<body class="bg-white text-slate-900 antialiased">
  <main class="mx-auto max-w-5xl p-6 sm:p-10 space-y-6">

    <!-- Header row: Blue title (span 2) + Purple status card -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <!-- Title + time -->
      <div class="card bg-orange-900 text-white p-6 sm:p-7 md:col-span-2">
        <div class="flex items-start justify-between gap-4">
          <h1 class="text-2xl sm:text-3xl font-bold tracking-tight flex items-center gap-2">
             Where is Michelle working right now?
          </h1>
          <span id="statusDot" class="relative inline-block h-3 w-3 rounded-full bg-emerald-400 status-ping"></span>
        </div>
        <p id="tinyDate" class="mt-2 text-sm/6 opacity-90"></p>
      </div>

      <!-- NEW: In-office / Where in the building (manual toggle driven) -->
      <div class="card bg-[#ff5f00] text-white p-6 sm:p-7">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">Work mode</h2>
          <span id="headerModeDot" class="relative inline-block h-3 w-3 rounded-full bg-amber-400">
            <span class="absolute inset-0 rounded-full animate-ping bg-amber-400/60"></span>
          </span>
        </div>
        <p id="headerModeText" class="mt-2 text-base font-bold">—</p>

        <div class="mt-4 pt-4 border-t border-white/25">
          <p class="text-sm/6 opacity-90">Where in the building</p>
          <p id="headerRoomText" class="mt-1 text-sm font-medium">—</p>
        </div>
      </div>
    </section>

    <!-- 2) Right now + Up next -->
    <section class="relative card bg-red-600 text-white p-6 sm:p-7">
      <div id="overrideSticker" class="hidden sticker">OVERRIDE</div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="md:col-span-2">
          <h2 class="text-xl sm:text-2xl font-semibold">Right now</h2>
          <p id="rightNow" class="mt-2 text-lg sm:text-xl font-bold"></p>
          <p id="friendlyNote" class="mt-2 text-sm/6 opacity-90 hidden"></p>
          <p id="daySummary" class="mt-3 text-xs/6 opacity-80"></p>
        </div>
        <div class="md:col-span-1">
          <h3 class="text-base font-semibold">Up next</h3>
          <p id="upNext" class="mt-2 text-sm/6 font-medium"></p>
        </div>
      </div>
    </section>

    <!-- 3) Contact banner (only shows when not at AHCD) -->
    <section id="ahcdBanner" class="hidden card bg-amber-500 text-slate-900 p-6 sm:p-7">
      <h3 class="text-lg font-semibold">Not at the Albert Hirschman Centre right now</h3>
      <p class="mt-2 text-sm">
        If you need help, you can reach the rest of the AHCD staff at
        <a class="underline font-medium" href="mailto:democracy.payments@graduateinstitute.ch">democracy.payments@graduateinstitute.ch</a>,
        <a class="underline font-medium" href="mailto:democracy.conferences@graduateinstitute.ch">democracy.conferences@graduateinstitute.ch</a>,
        or <a class="underline font-medium" href="mailto:democracy@graduateinstitute.ch">democracy@graduateinstitute.ch</a>
      </p>
    </section>

    <!-- 4) Weekly schedule (dynamic week window + overrides + specific-block highlight + rolling columns) -->
    <section class="card bg-emerald-600 text-white p-6 sm:p-7">
      <div class="flex items-center justify-between gap-4">
        <h3 class="text-lg font-semibold">Weekly schedule</h3>
        <p id="weekLabel" class="text-xs/6 opacity-90"></p>
      </div>
      <div class="mt-4 overflow-x-auto">
        <table class="w-full text-sm border-separate border-spacing-y-2">
          <thead>
            <tr id="theadRow" class="text-left">
              <th class="px-3 py-2 w-28">Block</th>
              <!-- Mon..Fri headers injected here -->
            </tr>
          </thead>
          <tbody class="[&_td]:align-top">
            <tr id="rowMorning" class="bg-emerald-700/30 rounded-xl">
              <td class="px-3 py-3 font-medium">Morning</td>
              <!-- Mon..Fri morning cells -->
            </tr>
            <tr id="rowAfternoon" class="bg-emerald-700/30 rounded-xl">
              <td class="px-3 py-3 font-medium">Afternoon</td>
              <!-- Mon..Fri afternoon cells -->
            </tr>
          </tbody>
        </table>
      </div>
      <p class="mt-3 text-xs/6 opacity-90">AM: 09:00–12:30 • Lunch: 12:30–13:30 • PM: 13:30–17:30 (Europe/Zurich)</p>
    </section>

  </main>

  <script>
    // ===== Manual "In office" flag (set by toggle.html) =====
    const OFFICE_KEY = 'michelle_in_office_flag'; // { on: true, expires: <ms> }

    function readOffice() {
      const raw = localStorage.getItem(OFFICE_KEY);
      if (!raw) return false;
      try {
        const obj = JSON.parse(raw);
        if (!obj?.on) return false;
        if (typeof obj.expires === 'number' && Date.now() > obj.expires) {
          localStorage.removeItem(OFFICE_KEY);
          return false;
        }
        return true;
      } catch { return false; }
    }

    // ------- Rota (Mon=1..Fri=5) -------
    const SCHEDULE = {
      1: { full: 'Democracy Centre (AHCD)' },
      2: { full: 'Democracy Centre (AHCD)' },
      3: { morning: 'Communications Office', afternoon: 'Democracy Centre (AHCD)' },
      4: { full: 'Communications Office' },
      5: { morning: 'Democracy Centre (AHCD)', afternoon: 'Global Health Centre' }
    };
    const AM_START = "09:00", PM_START = "13:30";
    const AM_END = 12*60 + 30, LUNCH_END = 13*60 + 30, PM_END = 17*60 + 30;

    const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];

    function zfmt(opts){ return new Intl.DateTimeFormat('en-GB', { timeZone: 'Europe/Zurich', ...opts }).format(new Date()); }
    function zparts(){
      const p = new Intl.DateTimeFormat('en-GB', {
        timeZone:'Europe/Zurich', hour:'2-digit', minute:'2-digit',
        weekday:'long', year:'numeric', month:'2-digit', day:'2-digit'
      }).formatToParts(new Date());
      const o = Object.fromEntries(p.map(x=>[x.type,x.value]));
      return { weekday:o.weekday, hour:+o.hour, minute:+o.minute, y:+o.year, m:+o.month, d:+o.day };
    }
    function minutesNow(){ const {hour,minute}=zparts(); return hour*60 + minute; }
    function todayIdx(){ return days.indexOf(zparts().weekday); } // 0..6
    function normalizeEntryForWeekday(wIdx){ const e=SCHEDULE[wIdx]; if(!e) return null; return e.full?{morning:e.full, afternoon:e.full}:{morning:e.morning, afternoon:e.afternoon}; }
    function nextWorkdayIndex(wIdx){ if(wIdx<1||wIdx>5) return 1; return wIdx===5?1:wIdx+1; }

    // ---- TODAY card logic ----
    function computeTodayCard(){
      const nowMins=minutesNow(); const idx=todayIdx(); const entry=normalizeEntryForWeekday(idx);
      if(!entry){
        const nextMorning=normalizeEntryForWeekday(1)?.morning||'—';
        return { current:'Not scheduled — check email.', next:`${AM_START} — ${nextMorning}`, summary:'Weekend', atAHCD:false, note:'' };
      }
      if(nowMins < AM_END) return { current: entry.morning, next:`${PM_START} — ${entry.afternoon}`, summary:`Morning — ${entry.morning} / Afternoon — ${entry.afternoon}`, atAHCD:/hirschman|ahcd/i.test(entry.morning), note:'' };
      if(nowMins < LUNCH_END) return { current:'Lunch break', next:`${PM_START} — ${entry.afternoon}`, summary:`Morning — ${entry.morning} / Afternoon — ${entry.afternoon}`, atAHCD:false, note:'Lunch break — see “Up next” for where to find me at 13:30.' };
      if(nowMins < PM_END){ const nextIdx=nextWorkdayIndex(idx); const nextMorning=normalizeEntryForWeekday(nextIdx)?.morning||'—'; return { current: entry.afternoon, next:`${AM_START} — ${nextMorning}`, summary:`Morning — ${entry.morning} / Afternoon — ${entry.afternoon}`, atAHCD:/hirschman|ahcd/i.test(entry.afternoon), note:'' }; }
      const nextIdx=nextWorkdayIndex(idx); const nextMorning=normalizeEntryForWeekday(nextIdx)?.morning||'—';
      return { current:'Day complete', next:`${AM_START} — ${nextMorning}`, summary:`Morning — ${entry.morning} / Afternoon — ${entry.afternoon}`, atAHCD:false, note:'Not working after hours — if you are in this time zone you should log off too!' };
    }

    // ---- Week window with ROLLING columns ----
    function startOfMonday(date){
      const d = new Date(date);
      const idx = todayIdx();
      const todayLocal = new Date();
      const deltaToMon = ((idx+6)%7);
      const mon = new Date(todayLocal);
      mon.setDate(todayLocal.getDate() - deltaToMon);
      mon.setHours(0,0,0,0);
      return mon;
    }
    function addDays(date,n){ const d=new Date(date); d.setDate(d.getDate()+n); return d; }
    function ymd(date){ const y=date.getFullYear(), m=String(date.getMonth()+1).padStart(2,'0'), d=String(date.getDate()).padStart(2,'0'); return `${y}-${m}-${d}`; }
    function labelDay(date){ return new Intl.DateTimeFormat('en-GB', { day:'2-digit', month:'short' }).format(date); }

    function shouldColumnRollToNextWeek(columnWeekday, nowWeekday, nowMins){
      if (nowWeekday===6 || nowWeekday===0) return true;
      const nowW = nowWeekday;
      const colW = columnWeekday;
      if (colW < nowW) return true;
      if (colW === nowW && nowMins >= PM_END) return true;
      return false;
    }

    // ---- Overrides file ----
    async function fetchOverrides(){
      try {
        const res = await fetch('overrides.json', { cache:'no-store' });
        if (!res.ok) return [];
        const list = await res.json();
        return Array.isArray(list) ? list : [];
      } catch { return []; }
    }
    function buildOverrideMap(list){
      const map = new Map();
      for (const item of list){
        if (item.date){
          map.set(item.date, item);
        } else if (item.date_range?.start && item.date_range?.end){
          map.set(`${item.date_range.start}..${item.date_range.end}`, item);
        }
      }
      return map;
    }
    function findOverrideForDate(map, dateStr){
      if (map.has(dateStr)) return map.get(dateStr);
      for (const [key,val] of map.entries()){
        if (!key.includes('..')) continue;
        const [s,e]=key.split('..');
        if (dateStr>=s && dateStr<=e) return val;
      }
      return null;
    }

    // ---- Map current location to a room label ----
    function mapRoomFromLocation(loc){
      const s = (loc || '').toLowerCase();
      if (/communications/.test(s)) return '8th floor';
      if (/hirschman|ahcd/.test(s)) return 'P1-457';
      return '—';
    }

    // ---- Render ----
    document.getElementById('tinyDate').textContent =
      `${zfmt({weekday:'long', day:'numeric', month:'long', year:'numeric'})} • ${zfmt({hour:'2-digit', minute:'2-digit'})} (Europe/Zurich)`;

    (async function init(){
      // TODAY card + possible override
      let state = computeTodayCard();
      const todayISO = (()=>{ const now=new Date(); const y=now.getFullYear(); const m=String(now.getMonth()+1).padStart(2,'0'); const d=String(now.getDate()).padStart(2,'0'); return `${y}-${m}-${d}`; })();
      const overrides = await fetchOverrides();
      const ovMap = buildOverrideMap(overrides);
      const ovToday = findOverrideForDate(ovMap, todayISO);
      if (ovToday){
        if (ovToday.location) state.current = ovToday.location;
        if (ovToday.upNext)   state.next    = ovToday.upNext;
        if (ovToday.note)     state.note    = ovToday.note;
        const s = document.getElementById('overrideSticker');
        s.textContent = ovToday.badgeText || 'OVERRIDE';
        s.classList.remove('hidden');
      }
      document.getElementById('rightNow').textContent = state.current;
      document.getElementById('upNext').textContent   = state.next;
      document.getElementById('daySummary').textContent = state.summary;
      if (state.note) { const n=document.getElementById('friendlyNote'); n.textContent=state.note; n.classList.remove('hidden'); }
      if (!state.atAHCD) { document.getElementById('ahcdBanner').classList.remove('hidden'); const dot=document.getElementById('statusDot'); dot.classList.remove('bg-emerald-400'); dot.classList.add('bg-amber-300'); }

      // WEEK table with dynamic rolling columns + block-level highlight + overrides
      const nowMins = minutesNow();
      const nowWIdx = todayIdx(); // 0..6
      const thisMonday = startOfMonday(new Date());
      const nextMonday = addDays(thisMonday, 7);

      const columnDates = [];
      for (let col=1; col<=5; col++){
        const roll = shouldColumnRollToNextWeek(col, nowWIdx===0?7:nowWIdx, nowMins);
        const base = roll ? nextMonday : thisMonday;
        columnDates.push( addDays(base, col-1) );
      }

      const weekLabel = `${labelDay(columnDates[0])} → ${labelDay(columnDates[4])}`;
      document.getElementById('weekLabel').textContent = `Showing: ${weekLabel}`;

      const theadRow = document.getElementById('theadRow');
      ['Mon','Tue','Wed','Thu','Fri'].forEach((name,i)=>{
        const th = document.createElement('th');
        th.className = "px-3 py-2";
        th.textContent = `${name} ${labelDay(columnDates[i])}`;
        theadRow.appendChild(th);
      });

      const rowM = document.getElementById('rowMorning');
      const rowA = document.getElementById('rowAfternoon');

      for (let i=0;i<5;i++){
        const dateObj = columnDates[i];
        const iso = ymd(dateObj);
        const weekdayNumber = (i+1); // 1..5
        const rota = normalizeEntryForWeekday(weekdayNumber);
        const over = findOverrideForDate(ovMap, iso);

        const tdM = document.createElement('td');
        tdM.className = "px-3 py-3 td-wrap cell";
        tdM.textContent = rota?.morning || '—';
        if (over && over.location){
          const s = document.createElement('span'); s.className="sticker"; s.textContent = over.badgeText || 'OVERRIDE'; tdM.appendChild(s);
        }
        rowM.appendChild(tdM);

        const tdA = document.createElement('td');
        tdA.className = "px-3 py-3 td-wrap cell";
        tdA.textContent = rota?.afternoon || '—';
        if (over && over.location){
          const s2 = document.createElement('span'); s2.className="sticker"; s2.textContent = over.badgeText || 'OVERRIDE'; tdA.appendChild(s2);
        }
        rowA.appendChild(tdA);
      }

      // Highlight active block (if today’s column not rolled)
      const todayColIndex = (() => {
        const w = (nowWIdx===0||nowWIdx===6) ? null : (nowWIdx-1);
        if (w===null) return null;
        const rolled = shouldColumnRollToNextWeek(nowWIdx, nowWIdx, nowMins);
        if (rolled) return null;
        return w;
      })();
      if (todayColIndex !== null){
        if (nowMins < AM_END) rowM.children[todayColIndex+1].classList.add('active-block');
        else if (nowMins >= LUNCH_END && nowMins < PM_END) rowA.children[todayColIndex+1].classList.add('active-block');
      }

      // ===== NEW: Fill the purple header status card =====
      const inOffice = readOffice(); // manual flag only
      const headerDot = document.getElementById('headerModeDot');
      const headerText = document.getElementById('headerModeText');
      const roomText = document.getElementById('headerRoomText');

      headerText.textContent = inOffice ? 'In office' : 'Working from home';
      headerDot.className = "relative inline-block h-3 w-3 rounded-full " + (inOffice ? "bg-emerald-400" : "bg-amber-400");
      headerDot.innerHTML = `<span class="absolute inset-0 rounded-full animate-ping ${inOffice ? 'bg-emerald-400/60' : 'bg-amber-400/60'}"></span>`;

      // Room: override via URL (?room=...), else map from current location
      const urlRoom = new URLSearchParams(location.search).get('room');
      const mappedRoom = mapRoomFromLocation(state.current);
      roomText.textContent = urlRoom ? decodeURIComponent(urlRoom) : mappedRoom;

    })();
  </script>
</body>
</html>
