<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Where is Michelle working today?</title>
  <meta name="description" content="Quick daily location + schedule for Michelle." />
  <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Ubuntu', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    .card { border-radius: 1rem; box-shadow: 0 8px 24px rgba(0,0,0,.08); }
    .status-ping::before { content:""; position:absolute; inset:-6px; border-radius:9999px; border:2px solid rgba(255,255,255,.45); animation: ping 1.5s cubic-bezier(0, 0, 0.2, 1) infinite; }
    @keyframes ping { 75%,100% { transform:scale(1.6); opacity:0; } }
    .table-fixed { table-layout: fixed; }
    .td-wrap { word-wrap: break-word; }
    /* Override sticker */
    .sticker {
      position: absolute; top: .75rem; right: .75rem;
      transform: rotate(6deg);
      padding: .35rem .6rem; border-radius: .5rem;
      background: #fb7185; color: #fff; font-weight: 700; font-size: .75rem;
      box-shadow: 0 4px 14px rgba(0,0,0,.15);
      letter-spacing: .5px;
    }
  </style>
</head>
<body class="bg-white text-slate-900 antialiased">
  <main class="mx-auto max-w-4xl p-6 sm:p-10 space-y-6">

    <!-- 1) Title + time -->
    <section class="card bg-blue-600 text-white p-6 sm:p-7">
      <div class="flex items-start justify-between gap-4">
        <h1 class="text-2xl sm:text-3xl font-bold tracking-tight flex items-center gap-2">
          <span>üìç</span> Where is Michelle working today?
        </h1>
        <span id="statusDot" class="relative inline-block h-3 w-3 rounded-full bg-emerald-400 status-ping"></span>
      </div>
      <p id="tinyDate" class="mt-2 text-sm/6 opacity-90"></p>
    </section>

    <!-- 2) Right now + Up next -->
    <section class="relative card bg-red-600 text-white p-6 sm:p-7">
      <div id="overrideSticker" class="hidden sticker">OVERRIDE</div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="md:col-span-2">
          <h2 class="text-xl sm:text-2xl font-semibold">Right now</h2>
          <p id="rightNow" class="mt-2 text-lg sm:text-xl font-bold"></p>
          <p id="friendlyNote" class="mt-2 text-sm/6 opacity-90 hidden"></p>
          <p id="daySummary" class="mt-3 text-xs/6 opacity-80"></p>
        </div>
        <div class="md:col-span-1">
          <h3 class="text-base font-semibold">Up next</h3>
          <p id="upNext" class="mt-2 text-sm/6 font-medium"></p>
        </div>
      </div>
    </section>

    <!-- 3) Contact banner (only shows when not at AHCD) -->
    <section id="ahcdBanner" class="hidden card bg-amber-500 text-slate-900 p-6 sm:p-7">
      <h3 class="text-lg font-semibold">Not at the Albert Hirschman Centre today</h3>
      <p class="mt-2 text-sm">
        If you need help, you can reach the rest of the AHCD staff at
        <a class="underline font-medium" href="mailto:democracy.payments@graduateinstitute.ch">democracy.payments</a>,
        <a class="underline font-medium" href="mailto:democracy.conferences@graduateinstitute.ch">democracy.conferences</a>,
        or <a class="underline font-medium" href="mailto:democracy@graduateinstitute.ch">democracy</a>
        <span>@graduateinstitute.ch</span>.
      </p>
    </section>

    <!-- 4) Weekly schedule (horizontal table) -->
    <section class="card bg-emerald-600 text-white p-6 sm:p-7">
      <h3 class="text-lg font-semibold">Weekly schedule</h3>
      <div class="mt-4 overflow-x-auto">
        <table class="w-full table-fixed text-sm border-separate border-spacing-y-2">
          <thead>
            <tr class="text-left">
              <th class="px-3 py-2 w-28">Block</th>
              <th class="px-3 py-2">Mon</th>
              <th class="px-3 py-2">Tue</th>
              <th class="px-3 py-2">Wed</th>
              <th class="px-3 py-2">Thu</th>
              <th class="px-3 py-2">Fri</th>
            </tr>
          </thead>
          <tbody class="[&_td]:align-top">
            <tr class="bg-emerald-700/30 rounded-xl">
              <td class="px-3 py-3 font-medium">Morning</td>
              <td class="px-3 py-3 td-wrap">AHCD</td>
              <td class="px-3 py-3 td-wrap">AHCD</td>
              <td class="px-3 py-3 td-wrap">Communications Office</td>
              <td class="px-3 py-3 td-wrap">Communications Office</td>
              <td class="px-3 py-3 td-wrap">AHCD</td>
            </tr>
            <tr class="bg-emerald-700/30 rounded-xl">
              <td class="px-3 py-3 font-medium">Afternoon</td>
              <td class="px-3 py-3 td-wrap">AHCD</td>
              <td class="px-3 py-3 td-wrap">AHCD</td>
              <td class="px-3 py-3 td-wrap">AHCD</td>
              <td class="px-3 py-3 td-wrap">Communications Office</td>
              <td class="px-3 py-3 td-wrap">Global Health Centre</td>
            </tr>
          </tbody>
        </table>
      </div>
      <p class="mt-3 text-xs/6 opacity-90">AM: 09:00‚Äì12:30 ‚Ä¢ Lunch: 12:30‚Äì13:30 ‚Ä¢ PM: 13:30‚Äì17:30 (Europe/Zurich)</p>
    </section>

  </main>

  <script>
    // ------- Config: Weekly schedule map (Mon=1..Fri=5) -------
    const SCHEDULE = {
      1: { full: 'Albert Hirschman Centre on Democracy (AHCD)' },
      2: { full: 'Albert Hirschman Centre on Democracy (AHCD)' },
      3: { morning: 'Communications Office', afternoon: 'AHCD' },
      4: { full: 'Communications Office' },
      5: { morning: 'AHCD', afternoon: 'Global Health Centre' }
    };
    const AM_START = "09:00"; const PM_START = "13:30";
    const AM_END = 12*60 + 30, LUNCH_END = 13*60 + 30, PM_END = 17*60 + 30;

    const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
    function zfmt(opts){ return new Intl.DateTimeFormat('en-GB', { timeZone: 'Europe/Zurich', ...opts }).format(new Date()); }
    function zparts(){ const p=new Intl.DateTimeFormat('en-GB',{timeZone:'Europe/Zurich',hour:'2-digit',minute:'2-digit',weekday:'long'}).formatToParts(new Date()); const o=Object.fromEntries(p.map(x=>[x.type,x.value])); return { weekday:o.weekday, hour:+o.hour, minute:+o.minute, y: new Date().getFullYear(), m: new Date().getMonth()+1, d: new Date().getDate() }; }
    function minutesNow(){ const {hour,minute}=zparts(); return hour*60+minute; }
    function todayIndex(){ return days.indexOf(zparts().weekday); }
    function normalizeEntryForDay(idx){ const e=SCHEDULE[idx]; if(!e) return null; return e.full?{morning:e.full,afternoon:e.full}:{morning:e.morning,afternoon:e.afternoon}; }
    function nextWorkdayIndex(idx){ if(idx<1||idx>5) return 1; return idx===5?1:idx+1; }

    function computeState(){
      const nowMins=minutesNow(); const idx=todayIndex(); const entry=normalizeEntryForDay(idx);
      if(!entry){ const nextMorning=normalizeEntryForDay(1)?.morning||'‚Äî'; return {current:'Not scheduled ‚Äî check email.', next:`${AM_START} ‚Äî ${nextMorning}`, summary:'Weekend', atAHCD:false, note:''}; }
      if(nowMins < AM_END) return { current: entry.morning, next: `${PM_START} ‚Äî ${entry.afternoon}`, summary:`Morning ‚Äî ${entry.morning} / Afternoon ‚Äî ${entry.afternoon}`, atAHCD:/hirschman|ahcd/i.test(entry.morning), note:'' };
      if(nowMins < LUNCH_END) return { current:'Lunch break', next:`${PM_START} ‚Äî ${entry.afternoon}`, summary:`Morning ‚Äî ${entry.morning} / Afternoon ‚Äî ${entry.afternoon}`, atAHCD:false, note:'Lunch break ‚Äî see ‚ÄúUp next‚Äù for where to find me at 13:30.' };
      if(nowMins < PM_END){ const nextIdx=nextWorkdayIndex(idx); const nextMorning=normalizeEntryForDay(nextIdx)?.morning||'‚Äî'; return { current: entry.afternoon, next:`${AM_START} ‚Äî ${nextMorning}`, summary:`Morning ‚Äî ${entry.morning} / Afternoon ‚Äî ${entry.afternoon}`, atAHCD:/hirschman|ahcd/i.test(entry.afternoon), note:'' }; }
      const nextIdx=nextWorkdayIndex(idx); const nextMorning=normalizeEntryForDay(nextIdx)?.morning||'‚Äî';
      return { current:'Day complete', next:`${AM_START} ‚Äî ${nextMorning}`, summary:`Morning ‚Äî ${entry.morning} / Afternoon ‚Äî ${entry.afternoon}`, atAHCD:false, note:'Not working after hours ‚Äî if you are in this time zone you should log off too!' };
    }

    // --- Apply override if present for today ---
    async function fetchOverride(){
      try {
        const res = await fetch('overrides.json', { cache: 'no-store' });
        if (!res.ok) return null;
        const list = await res.json(); if (!Array.isArray(list)) return null;

        // today in YYYY-MM-DD
        const dt = new Date();
        const yyyy = dt.getFullYear();
        const mm = String(dt.getMonth()+1).padStart(2,'0');
        const dd = String(dt.getDate()).padStart(2,'0');
        const today = `${yyyy}-${mm}-${dd}`;

        function inRange(item){
          if (item.date === today) return true;
          const r = item.date_range;
          if (r && r.start && r.end) return today >= r.start && today <= r.end;
          return false;
        }

        const hit = list.find(inRange);
        return hit || null;
      } catch { return null; }
    }

    // ---- Render ----
    document.getElementById('tinyDate').textContent =
      `${zfmt({weekday:'long', day:'numeric', month:'long', year:'numeric'})} ‚Ä¢ ${zfmt({hour:'2-digit', minute:'2-digit'})} (Europe/Zurich)`;

    (async function init(){
      let state = computeState();
      const override = await fetchOverride();

      // If override exists, replace fields and show sticker
      if (override){
        if (override.location) state.current = override.location;
        if (override.upNext)   state.next    = override.upNext;
        if (override.note)     state.note    = override.note;
        // Make sticker visible
        const s = document.getElementById('overrideSticker');
        s.textContent = override.badgeText || 'OVERRIDE';
        s.classList.remove('hidden');
      }

      document.getElementById('rightNow').textContent = state.current;
      document.getElementById('upNext').textContent   = state.next;
      document.getElementById('daySummary').textContent = state.summary;

      // Friendly note (only if set)
      const noteEl = document.getElementById('friendlyNote');
      if (state.note) { noteEl.textContent = state.note; noteEl.classList.remove('hidden'); }

      // AHCD banner + status dot color
      if (!state.atAHCD) {
        document.getElementById('ahcdBanner').classList.remove('hidden');
        const dot = document.getElementById('statusDot');
        dot.classList.remove('bg-emerald-400');
        dot.classList.add('bg-amber-300');
      }
    })();
  </script>
</body>
</html>
